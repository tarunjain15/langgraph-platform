```yaml
task_id: M7.1
phase: M7
type: Automation
status: pending
created: 2025-11-17
```

# Task 7.1: [Automation] Auto-Scaling Based on Metrics

## The Constraint

**Before:** Manual scaling decisions → delayed response to load
**After:** PostgreSQL auto-scales (t4g.small → m5.large) at >500 writes/sec

---

## The Witness

**Observable Truth:** CloudWatch alarm triggers at 500 writes/sec, RDS auto-scales to larger instance, no manual intervention

---

## Acceptance Criteria

- [ ] CloudWatch alarm configured for >500 writes/sec threshold
- [ ] Auto-scaling policy defined (t4g.small → m5.large)
- [ ] Scaling test successful (simulate 500+ writes/sec)
- [ ] Instance scales up automatically
- [ ] Instance scales down when load decreases
- [ ] Zero downtime during scaling

---

## Code Pattern

```hcl
# Terraform: CloudWatch alarm + auto-scaling
resource "aws_cloudwatch_metric_alarm" "high_write_throughput" {
  alarm_name          = "checkpoints-high-write-throughput"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 2
  metric_name         = "DatabaseConnections"
  namespace           = "AWS/RDS"
  period              = 300  # 5 minutes
  statistic           = "Average"
  threshold           = 80   # 80% of max connections

  alarm_actions = [aws_sns_topic.scaling_alerts.arn]
}

# Auto-scaling configuration
resource "aws_appautoscaling_target" "rds" {
  service_namespace  = "rds"
  resource_id        = "cluster:${aws_rds_cluster.checkpoints.id}"
  scalable_dimension = "rds:cluster:ReadReplicaCount"
  min_capacity       = 1
  max_capacity       = 5
}

resource "aws_appautoscaling_policy" "rds_scale_up" {
  name               = "rds-scale-up"
  service_namespace  = "rds"
  resource_id        = aws_appautoscaling_target.rds.resource_id
  scalable_dimension = aws_appautoscaling_target.rds.scalable_dimension
  policy_type        = "TargetTrackingScaling"

  target_tracking_scaling_policy_configuration {
    predefined_metric_specification {
      predefined_metric_type = "RDSReaderAverageDatabaseConnections"
    }
    target_value = 75.0
  }
}
```

---

## The Completion Signal

**Signal:** Auto-scaling triggered and verified during load test

**Evidence:** CloudWatch alarm logs, RDS scaling events, zero downtime verified

---

## Notes

**Scaling Threshold:** 500 writes/sec = 5x PostgreSQL baseline (100/sec). Conservative trigger.

**Downtime:** RDS instance scaling has ~2-5 min downtime. Use read replicas for zero-downtime scaling.
