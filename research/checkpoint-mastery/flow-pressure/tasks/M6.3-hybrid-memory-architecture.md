```yaml
task_id: M6.3
phase: M6
type: Pattern
status: pending
created: 2025-11-17
```

# Task 6.3: [Pattern] Hybrid Memory Architecture

## The Constraint

**Before:** Everything in checkpoints â†’ large state, slow serialization
**After:** Checkpoints <10KB (temporal state), Store for persistent facts (timeless knowledge)

---

## The Witness

**Observable Truth:** Average checkpoint size <10KB, persistent facts in Store, both systems working together

---

## Acceptance Criteria

- [ ] Checkpoint stores only temporal state (messages, current step)
- [ ] Store stores persistent facts (user preferences, learned knowledge)
- [ ] Average checkpoint size <10KB
- [ ] Agent uses both checkpoint (context) and store (knowledge)
- [ ] Clear separation of concerns documented

---

## Code Pattern

```python
# Hybrid architecture pattern
class HybridMemoryAgent:
    def __init__(self, checkpointer, store):
        self.checkpointer = checkpointer
        self.store = store

    async def process(self, state, config):
        # Temporal context from checkpoint (this conversation)
        current_messages = state["messages"]

        # Timeless knowledge from store (persistent facts)
        user_prefs = await self.store.get(
            namespace=["user_preferences", state["user_id"]],
            key="preferences"
        )

        # Combine both
        response = await self.agent(
            messages=current_messages,  # Temporal
            preferences=user_prefs      # Timeless
        )

        # Store new learnings (if any)
        if response.get("learned_fact"):
            await self.store.put(
                namespace=["learned_facts", state["user_id"]],
                key=f"fact_{timestamp}",
                value=response["learned_fact"]
            )

        return {"messages": [response]}
```

---

## The Completion Signal

**Signal:** Checkpoints <10KB, Store contains persistent facts, hybrid pattern working

**Evidence:** Checkpoint size metrics, Store usage metrics, pattern documentation

---

## Notes

**Separation:** Checkpoint = what happened (temporal). Store = what we know (timeless).

**Performance:** Small checkpoints = fast serialization. Store queries only when needed.

**Cost Optimization:** Checkpoints expire (M2.4 pruning). Store persists indefinitely = different retention strategies.
