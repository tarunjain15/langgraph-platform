```yaml
task_id: M7.2
phase: M7
type: Cost
status: pending
created: 2025-11-17
```

# Task 7.2: [Cost] Checkpoint Tiering Strategy

## The Constraint

**Before:** All checkpoints in PostgreSQL → $3,680/month at scale
**After:** Hot checkpoints in Redis, cold in PostgreSQL → $126/month (96% cost reduction)

---

## The Witness

**Observable Truth:** Cost analysis shows $126/month (Redis + PostgreSQL) vs $3,680 (PostgreSQL-only)

---

## Acceptance Criteria

- [ ] Redis configured for hot checkpoints (last 24 hours)
- [ ] PostgreSQL stores cold checkpoints (>24 hours old)
- [ ] Tiering logic migrates checkpoints Redis → PostgreSQL after 24 hours
- [ ] Read path checks Redis first, falls back to PostgreSQL
- [ ] Cost reduction >90% verified

---

## Code Pattern

```python
class TieredCheckpointer:
    """Hot (Redis) + Cold (PostgreSQL) tiering."""

    def __init__(self, redis_client, postgres_checkpointer):
        self.hot = redis_client  # Fast, expensive
        self.cold = postgres_checkpointer  # Slower, cheap

    async def aput(self, config, checkpoint, metadata, new_versions):
        # Always write to hot tier (Redis)
        thread_id = config["configurable"]["thread_id"]
        checkpoint_id = checkpoint["id"]

        await self.hot.set(
            f"checkpoint:{thread_id}:{checkpoint_id}",
            pickle.dumps(checkpoint),
            ex=86400  # 24 hour TTL
        )

        # Async migration to cold tier after TTL
        # (handled by background job, not inline)

    async def aget(self, config):
        # Try hot tier first (Redis)
        thread_id = config["configurable"]["thread_id"]
        checkpoint_id = config["configurable"].get("checkpoint_id")

        hot_data = await self.hot.get(f"checkpoint:{thread_id}:{checkpoint_id}")
        if hot_data:
            return pickle.loads(hot_data)

        # Fall back to cold tier (PostgreSQL)
        return await self.cold.aget(config)

# Background migration job (runs every hour)
async def migrate_cold_checkpoints():
    """Move Redis checkpoints >24h old to PostgreSQL."""
    # Redis TTL auto-expires at 24h
    # Before expiry, copy to PostgreSQL
    pass
```

---

## The Completion Signal

**Signal:** Cost analysis shows >90% reduction ($3,680 → $126)

**Evidence:** Cost breakdown, tiering logic tested, performance acceptable

---

## Notes

**Cost Math:**
- PostgreSQL-only: 100K checkpoints × ~$0.037/checkpoint = $3,680/month
- Tiered: Redis (hot 24h) $50 + PostgreSQL (cold) $76 = $126/month

**Trade-off:** Redis adds latency to cold reads (Redis miss → PostgreSQL query). Acceptable for >24h old checkpoints.
