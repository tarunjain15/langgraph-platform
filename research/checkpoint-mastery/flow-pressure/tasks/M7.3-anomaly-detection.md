```yaml
task_id: M7.3
phase: M7
type: Observability
status: pending
created: 2025-11-17
```

# Task 7.3: [Observability] Anomaly Detection

## The Constraint

**Before:** Only threshold alerts → miss subtle degradation
**After:** Anomaly detection alerts when checkpoint >5MB or error rate spikes unexpectedly

---

## The Witness

**Observable Truth:** Alert fires when checkpoint exceeds 5MB (anomaly) or error rate 3σ above baseline

---

## Acceptance Criteria

- [ ] Anomaly detection configured for checkpoint size
- [ ] Alert fires when checkpoint >5MB (should be <10KB normally)
- [ ] Anomaly detection configured for error rate
- [ ] Alert fires when error rate >3 standard deviations above baseline
- [ ] Statistical baseline auto-updates weekly

---

## Code Pattern

```python
# Prometheus alert rules with anomaly detection
groups:
  - name: checkpoint_anomalies
    rules:
      # Size anomaly
      - alert: CheckpointSizeAnomaly
        expr: |
          checkpoint_size_bytes > 5000000  # 5MB
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Checkpoint size anomaly detected"
          description: "Checkpoint {{ $labels.thread_id }} is {{ $value }} bytes (>5MB)"

      # Error rate anomaly (statistical)
      - alert: ErrorRateAnomaly
        expr: |
          (
            rate(checkpoint_writes_total{status="error"}[5m]) -
            avg_over_time(rate(checkpoint_writes_total{status="error"}[1w])[1w:1h])
          ) /
          stddev_over_time(rate(checkpoint_writes_total{status="error"}[1w])[1w:1h])
          > 3  # 3 standard deviations above baseline
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Error rate anomaly detected"
          description: "Error rate {{ $value }}σ above baseline"

      # Throughput anomaly
      - alert: ThroughputAnomaly
        expr: |
          abs(
            rate(checkpoint_writes_total[5m]) -
            avg_over_time(rate(checkpoint_writes_total[1w])[1w:1h])
          ) /
          stddev_over_time(rate(checkpoint_writes_total[1w])[1w:1h])
          > 3
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Throughput anomaly detected"
          description: "Throughput {{ $value }}σ from baseline"
```

---

## The Completion Signal

**Signal:** Anomaly detection working, alert fires on 5MB checkpoint or statistical error spike

**Evidence:** Test alerts, baseline calculations verified, anomaly detection logs

---

## Notes

**Statistical Anomalies:** 3σ threshold catches 99.7% of normal behavior. Anything beyond = anomaly worth investigating.

**Baseline:** Auto-updates weekly to adapt to traffic patterns. No manual threshold tuning needed.

**Size Anomaly:** 5MB checkpoint indicates M2.2 (blob externalization) bypassed. Investigate immediately.
